# 【计网】数据链路层

## 数据链路层概述

#### 数据链路层在网络体系结构中所处的地位

![image-20241106175203525](https://gitee.com/ForeverHamburger/picgo_imgs1/raw/master/202411061752627.png)

#### 链路、数据链路和帧

链路(Link)是指从一个节点到相邻节点的一段物理线路(有线或无线)，而中间没有任何其他的交换节点。

数据链路(Data Link)是基于链路的。当在一条链路上传送数据时，除需要链路本身，还需要一些必要的通信协议来控制这些数据的传输，把实现这些协议的硬件和软件加到链路上，就构成了数据链路。

计算机中的网络适配器(俗称网卡)和其相应的软件驱动程序就实现了这些协议。一般的网络适配器都包含了物理层和数据链路层这两层的功能。

帧(Frame)是数据链路层对等实体之间在水平方向进行逻辑通信的协议数据单元PDU

## 数据链路层三个重要问题

#### 封装成帧和透明传输

<img src="https://gitee.com/ForeverHamburger/picgo_imgs1/raw/master/202411061759206.png" alt="image-20241106175932139" style="zoom:33%;" />

透明传输

<img src="https://gitee.com/ForeverHamburger/picgo_imgs1/raw/master/202411061800053.png" alt="image-20241106180033982" style="zoom:33%;" />

#### 差错检测

<img src="https://gitee.com/ForeverHamburger/picgo_imgs1/raw/master/202411061802574.png" alt="image-20241106180221534" style="zoom:33%;" />

#### 可靠传输

<img src="https://gitee.com/ForeverHamburger/picgo_imgs1/raw/master/202411061803868.png" alt="image-20241106180330815" style="zoom:33%;" />

## 封装成帧和透明传输

#### 封装成帧

封装成帧是指数据链路层给上层交付下来的协议数据单元PDU，添加一个首部和一个尾部，使之成为帧。

![image-20241106222038992](https://gitee.com/ForeverHamburger/picgo_imgs1/raw/master/202411062220122.png)

为了提高数据链路层传输帧的效率，应当使帧的数据载荷的长度尽可能地大于首部和尾部的长度。

考虑到对缓存空间的需求以及差错控制等诸多因素，每一种数据链路层协议都规定了帧的数据载荷的长度上限，即最大传送单元(MaximumTransferUnit，MTU)。例如，以太网的MTU为1500个字节。

#### 透明传输

透明传输是指数据链路层对上层交付下来的协议数据单元PDU没有任何限制，就好像数据链路层不存在一样。

对于面向字节的物理链路使用字节填充的方法实现透明传输。

> 例如在帧定界符填充转义字符

![image-20241107101944134](https://gitee.com/ForeverHamburger/picgo_imgs1/raw/master/202411071019185.png)

对于面向比特的物理链路，使用比特填充的方法实现透明传输。

## 差错检测

#### 误码相关概念

实际的通信链路都不是理想的，比特在传输过程中可能会产生差错(称为比特差错)

> 比特1可能变成比特0
>
> 比特0可能变成比特1

在一段时间内，传输错误的比特数量占所传输比特总数的比率称为误码率(BitError Rate，BER)

提高链路的信噪比，可以降低误码率。但在实际的通信链路上，不可能使误码率下降为零。

使用差错检测技术来检测数据在传输过程中是否产生了比特差错，是数据链路层所要解决的重要
问题之一。

#### 奇偶校验

奇校验是在待发送的数据后面添加1个校验位，使得添加该校验位后的整个数据中比特1的个数为奇数。

偶校验是在待发送的数据后面添加1个校验位，使得添加该校验位后的整个数据中比特1的个数为偶数。

![image-20241107103649531](https://gitee.com/ForeverHamburger/picgo_imgs1/raw/master/202411071036601.png)

#### 循环冗余校验

数据链路层广泛使用漏检率极低的循环冗余校验(Cyclic Redundancy Check，CRC)检错技术。

循环冗余校验CRC的基本思想:

> 收发双方约定好一个生成多项式G(X)。
>
> 发送方基于待发送的数据和生成多项式G(X)，计算出差错检测码(冗余码)
>
> 将冗余码添加到待发送数据的后面一起传输。
>
> 接收方收到数据和冗余码后，通过生成多项式G(X)来计算收到的数据和冗余码是否产生了误码。

发送方CRC

<img src="https://gitee.com/ForeverHamburger/picgo_imgs1/raw/master/202411071043345.png" alt="image-20241107104347252" style="zoom:50%;" />

接收方CRC

![image-20241107104418279](https://gitee.com/ForeverHamburger/picgo_imgs1/raw/master/202411071044315.png)

> 奇偶校验、循环冗余校验等差错检测技术，只能检测出传输过程中出现了差错，但并不能定位错误因此无法纠正错误。
>
> 要想纠正传输中的差错，可以使用冗余信息更多的纠错码(例如海明码)进行前向纠错。但纠错码的开销比较大，在计算机网络中较少使用。
>
> 在计算机网络中，通常采用我们后续课程中将要介绍的检错重传方式来纠正传输中的差错，或者仅仅丢弃检测到差错的帧，这取决于数据链路层向其上层提供的是可靠传输服务还是不可靠传输服务。
>
> 循环冗余校验CRC具有很好的检错能力(漏检率极低)虽然计算比较复杂，但非常易于用硬件实现因此被广泛应用于数据链路层。

## 可靠传输

可靠传输的相关基本概念

使用差错检测技术(例如循环冗余校验CRC)接收方的数据链路层就可检测出帧在传输过程中是否
产生了误码(比特差错)。

> 数据链路层向其上层提供的服务类型
>
> 不可靠传输服务:仅仅丢弃有误码的帧，其他什么也不做。
>
> 可靠传输服务:通过某种机制实现发送方发送什么，接收方最终就能收到什么。

<img src="https://gitee.com/ForeverHamburger/picgo_imgs1/raw/master/202411071216735.png" alt="image-20241107121615687" style="zoom:33%;" />

可靠传输服务并不局限于数据链路层，，其他各层均可选择实现可靠传输。

可靠传输的实现比较复杂，开销比较大，是否使用可靠传输取决于应用需求。

![image-20241107121741498](https://gitee.com/ForeverHamburger/picgo_imgs1/raw/master/202411071217544.png)

#### 停止-等待协议

实现原理：

<img src="https://gitee.com/ForeverHamburger/picgo_imgs1/raw/master/202411071221480.png" alt="image-20241107122118410" style="zoom:33%;" />

#### 回退N帧协议

<img src="https://gitee.com/ForeverHamburger/picgo_imgs1/raw/master/202411081053925.png" alt="image-20241108105314768" style="zoom:33%;" />

#### 选择重传协议

![image-20241108105422923](https://gitee.com/ForeverHamburger/picgo_imgs1/raw/master/202411081054045.png)

## 点对点协议PPP

点对点协议(Point-to-Point Protocol，PPP)是目前使用最广泛的点对点数据链路层协议。

点对点协议PPP是因特网工程任务(interetEngineeringTaskForce，IETF)于1992年制定的。经过多次修订，目前PPP已成为因特网的正式标准IRFC1661，RFC16621。

<img src="https://gitee.com/ForeverHamburger/picgo_imgs1/raw/master/202411081055910.png" alt="image-20241108105553808" style="zoom:33%;" />

从网络体系结构角度看点对点协议PPP的组成。

<img src="https://gitee.com/ForeverHamburger/picgo_imgs1/raw/master/202411081056443.png" alt="image-20241108105648349" style="zoom:25%;" />

#### PPP帧格式

![image-20241108105744977](https://gitee.com/ForeverHamburger/picgo_imgs1/raw/master/202411081057049.png)

> 标志(Flag)字段:PPP帧的定界符，取值为0x7E。
>
> 地址(Address)字段:取值为0xFF，预留(目前没有什么作用)
>
> 控制(Control)字段:取值为0x03，预留(目前没有什么作用)
>
> 协议(Protocol)字段:其值用来指明帧的数据载荷应向上交付给哪个协议处理

![image-20241108105812235](https://gitee.com/ForeverHamburger/picgo_imgs1/raw/master/202411081058324.png)

#### PPP帧的透明传输

![image-20241108105935685](https://gitee.com/ForeverHamburger/picgo_imgs1/raw/master/202411081059767.png)

> 发送方的处理:
>
> (1)将数据载荷中出现的每一个0x7E减去0x20(相当于异或0x20)，然后在其前面插入转义字符0x7D
>
> 若数据载荷中原来就含有0x7D，则把每一个0x7D减去0x20，然后在其前面插入转义字符0x7D.
>
> (2)将数据载荷中出现的每一个ASCII码控制字符(即数值小于0x20的字符)
>
> (3)加上0x20(相当于异或0x20，将其转换成非控制字符)，然后在其前面插入转义字符0x7D
>
> 接收方的处理:
>
> 进行与发送方相反的变换，就可以正确地恢复出未经过字节填充的原始数据载荷。

![image-20241108110025355](https://gitee.com/ForeverHamburger/picgo_imgs1/raw/master/202411081100457.png)

#### PPP帧的差错检测

![image-20241108110053314](https://gitee.com/ForeverHamburger/picgo_imgs1/raw/master/202411081100402.png)

#### PPP的工作状态

以用户主机拨号接入因特网服务提供者ISP的拨号服务器的过程为例

![image-20241108110203072](https://gitee.com/ForeverHamburger/picgo_imgs1/raw/master/202411081102170.png)

## 共享式以太网

